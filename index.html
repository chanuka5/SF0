<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SF0 — Start From Zero</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --blue:#007aff; --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --danger:#ff3b30; --nav-active:#e6f0ff;
    --glass: rgba(255,255,255,0.85);
    --text: #0b1220;
    --liked-color: #007aff;
  }
  [data-theme="dark"]{
    --blue:#4ea1ff; --bg:#0b1220; --card:#07101a; --muted:#9aa6b2; --nav-active:rgba(78,161,255,0.09); --glass: rgba(255,255,255,0.02);
    --text: #ffffff;
    --liked-color: #4ea1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  header{padding:22px 16px;text-align:center;color:var(--blue);font-weight:700;font-size:22px}
  .container{max-width:1200px;margin:0 auto;padding:0 14px}
  .app {display:none}
  .layout{display:flex;gap:18px;padding-bottom:40px}
  .sidebar{
    width:240px; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06);
    height:calc(100vh - 120px); position:sticky; top:72px; overflow:auto; transition:transform .28s ease, width .22s ease;
  }
  .brand{display:flex;align-items:center;gap:12px;padding:10px 6px;margin-bottom:6px}
  .brand h3{margin:0;font-size:16px}
  .nav{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .nav-item{
    display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:all .18s ease;
    color:inherit;text-decoration:none;user-select:none; animation: slideInNav 0.5s forwards; opacity:0;
  }
  .nav-item .icon{font-size:18px}
  .nav-item .label{font-weight:600}
  .nav-item:hover{transform:translateX(6px);background:rgba(0,0,0,0.03)}
  .nav-item.active{background:var(--nav-active);color:var(--blue);box-shadow:0 6px 18px rgba(2,6,23,0.04);transform:none}
  .nav-item.logout {
    color: var(--danger);
    margin-top: auto;
    font-weight: 700;
  }
  .nav-item.logout:hover {
    background: rgba(255, 59, 48, 0.08);
  }
  .nav-item.logout .label {
      font-weight: 700;
  }
  .header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
  #menuToggle{display:none;background:transparent;border:0;font-size:22px;padding:8px 10px;cursor:pointer;border-radius:8px}
  .top-right{display:flex;align-items:center;gap:8px}
  .small-btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:#eef2ff}
  .btn{padding:10px 12px;border-radius:10px;border:0;background:var(--blue);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .content{flex:1}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.04);margin-bottom:16px; transition: all 0.5s ease; }
  .card.show { opacity: 1; transform: translateX(0); }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,textarea,select,button{font-family:inherit;font-size:15px}
  input,textarea,select{padding:10px;border-radius:8px;border:1px solid #e6e9f0;background:var(--card);color:var(--text)}
  textarea{min-height:100px;resize:vertical}
  .error{color:var(--danger);font-size:13px;margin-top:6px}
  .center-card{max-width:520px;margin:36px auto;padding:22px;background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  footer{padding:16px;text-align:center;color:var(--muted)}
  @media (max-width:900px){
    .layout{flex-direction:column}
    .sidebar{position:fixed;left:0;top:72px;height:calc(100vh - 72px);transform:translateX(-100%);z-index:1200;width:280px;box-shadow:8px 0 30px rgba(2,6,23,0.12)}
    .sidebar.open{transform:translateX(0)}
    #menuToggle{display:inline-block}
    .overlay{display:none}
    .overlay.open{display:block;position:fixed;inset:0;background:rgba(3,10,20,0.55);z-index:1100}
  }
  .inline-muted{color:var(--muted);font-size:13px}
  .post, .video, .positive, .complaint, .admin-row{border-radius:10px;padding:12px;margin-bottom:12px;background:var(--card);box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .controls{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .count{font-weight:600;margin-left:6px}
  .comment-box{margin-top:8px}
  .comment{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent)}
  .small-muted{font-size:12px;color:var(--muted)}
  .admin-panel{display:none;margin-bottom:12px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .tag{padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.04);font-size:12px}
  .edit-form input, .edit-form textarea{width:100%;margin-bottom:8px}
  .edit-controls{display:flex;gap:8px;justify-content:flex-end}
  .fade-in{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  @keyframes slideInNav { from {opacity:0; transform: translateY(10px)} to {opacity:1; transform: translateY(0)} }
  .nav-item:nth-child(1) { animation-delay: 0.1s; }
  .nav-item:nth-child(2) { animation-delay: 0.2s; }
  .nav-item:nth-child(3) { animation-delay: 0.3s; }
  .nav-item:nth-child(4) { animation-delay: 0.4s; }
  .nav-item:nth-child(5) { animation-delay: 0.5s; }
  .nav-item:nth-child(6) { animation-delay: 0.6s; }
  .nav-item:nth-child(7) { animation-delay: 0.7s; }
  .nav-item:nth-child(8) { animation-delay: 0.8s; }
  .nav-item:nth-child(9) { animation-delay: 0.9s; }
  .nav-item:nth-child(10) { animation-delay: 0.95s; }
  .nav-item.logout { animation-delay: 1s; }
  .video-title-link {
    color: var(--blue);
    text-decoration: none;
    font-size: 1.1em;
    display: block;
    margin-bottom: 8px;
    transition: color 0.1s ease;
  }
  .video-title-link:hover {
    color: var(--danger);
  }
  .like-btn.liked {
      background-color: var(--liked-color);
      color: var(--card);
      animation: bounce 0.3s ease-in-out;
  }
  @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
  }
  .admin-reply-box {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    background: var(--nav-active);
  }
  .user-reply-history {
    margin-top: 16px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 16px;
  }
  .social-links a {
      font-size: 24px;
      margin-right: 15px;
      color: var(--muted);
      transition: color 0.2s ease;
      text-decoration: none;
  }
  .social-links a:hover {
      color: var(--blue);
  }
  .ai-glow {
    animation: aiGlow 2s infinite alternate;
  }
  @keyframes aiGlow {
    from { box-shadow: 0 0 10px var(--blue); }
    to { box-shadow: 0 0 20px var(--blue); }
  }
  #growthChart { min-height: 300px; }
  .welcome-graphic {
    text-align: center;
    margin: 20px 0;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
  }
  .welcome-message {
    animation: typing 3s steps(40, end), blink-caret .75s step-end infinite;
    white-space: nowrap;
    overflow: hidden;
    border-right: .15em solid var(--blue);
    font-size: 1.5em;
    margin: 20px 0;
  }
  @keyframes typing {
    from { width: 0 }
    to { width: 100% }
  }
  @keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: var(--blue); }
  }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { border: 1px solid var(--muted); padding: 8px; text-align: left; }
  th { background: var(--nav-active); }
  .notification-item { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .notification-item:last-child { border-bottom: none; }
  .category-card {
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    color: var(--text);
    background: var(--card);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--muted);
  }
  .category-card:hover {
    box-shadow: 0 0 30px var(--blue);
  }
  .category-card h4 {
    text-shadow: none;
    transition: none;
    margin: 0;
  }
  .category-card:hover h4 {
    letter-spacing: 0;
  }
  .category-card .icon {
    font-size: 1.2em;
    color: var(--blue);
  }
</style>
</head>
<body>
<header>HY! WELCOME TO SF0</header>

<div id="authWrap" class="container">
  <div id="authCards" class="center-card fade-in ai-glow" aria-live="polite">
    <div id="loginView">
      <h2 style="margin:0 0 8px 0">Login</h2>
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPass" type="password" placeholder="Password" style="margin-top:8px" />
      <div class="row" style="margin-top:10px">
        <button id="loginBtn" class="btn">Login</button>
        <button id="showSignup" class="small-btn">Create account</button>
        <button id="forgotBtn" class="small-btn" style="background:#fff;border:1px solid #e6e9f0">Forgot password?</button>
      </div>
      <div id="loginError" class="error"></div>
      <div style="margin-top:10px" class="inline-muted">Email must be verified to login. Check your Spam folder.</div>
    </div>

    <div id="signupView" style="display:none">
      <h2 style="margin:0 0 8px 0">Create account</h2>
      <input id="signupEmail" type="email" placeholder="Email" />
      <input id="signupPass" type="password" placeholder="Password (6+ chars)" style="margin-top:8px" />
      <input id="signupFirstName" type="text" placeholder="First Name" style="margin-top:8px" />
      <input id="signupLastName" type="text" placeholder="Last Name" style="margin-top:8px" />
      <input id="signupDob" type="date" placeholder="Date of Birth" style="margin-top:8px" />
      <input id="signupContact" type="tel" placeholder="Contact Number" style="margin-top:8px" />
      <select id="signupGender" style="margin-top:8px">
        <option value="">Select Gender</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button id="signupBtn" class="btn">Sign up</button>
        <button id="showLogin" class="small-btn">Back to login</button>
      </div>
      <div id="signupError" class="error"></div>
      <div style="margin-top:10px" class="inline-muted">After signup, check your email and verify. You cannot login until verified.</div>
    </div>

    <div id="resetView" style="display:none">
      <h2 style="margin:0 0 8px 0">Reset password</h2>
      <input id="resetEmail" type="email" placeholder="Enter your account email" />
      <div class="row" style="margin-top:10px">
        <button id="sendReset" class="btn">Send reset link</button>
        <button id="backToLogin" class="small-btn">Back</button>
      </div>
      <div id="resetMsg" class="inline-muted" style="margin-top:8px"></div>
      <div id="resetError" class="error"></div>
    </div>

    <div id="detailsView" style="display:none">
      <h2 style="margin:0 0 8px 0">Complete Profile</h2>
      <div id="detailsEmail" class="muted"></div>
      <input id="detailsFirstName" type="text" placeholder="First Name" style="margin-top:8px" />
      <input id="detailsLastName" type="text" placeholder="Last Name" style="margin-top:8px" />
      <input id="detailsDob" type="date" placeholder="Date of Birth" style="margin-top:8px" />
      <input id="detailsContact" type="tel" placeholder="Contact Number" style="margin-top:8px" />
      <select id="detailsGender" style="margin-top:8px">
        <option value="">Select Gender</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button id="saveDetailsBtn" class="btn">Save Details</button>
      </div>
      <div id="detailsError" class="error"></div>
    </div>
  </div>
</div>

<div id="app" class="app container" style="display:none">
  <div class="header-bar">
    <div style="display:flex;align-items:center;gap:12px">
      <button id="menuToggle" aria-label="Open menu">☰</button>
      <div style="font-weight:700;color:var(--blue)">SF0 Dashboard</div>
    </div>

    <div class="top-right">
      <div class="notification-wrapper">
        <button id="notifToggle" class="small-btn" style="background:transparent; font-size:20px">🔔</button>
        <span id="notifCount" class="tag" style="display:none; margin-left:-10px; background:var(--danger); color:white; border-radius:50%; padding:2px 6px; font-size:12px">0</span>
      </div>
      <div class="inline-muted" id="currentEmail">Not signed</div>
    </div>
  </div>
  <div id="notifDropdown" style="display:none; position:absolute; right:16px; top:60px; width:300px; max-height:400px; overflow:auto; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(2,6,23,0.04); z-index:1000">
    <h4 style="margin:0 0 8px 0">Notifications</h4>
    <div id="notifList"></div>
  </div>

  <div class="layout">
    <nav class="sidebar" id="sidebar" aria-label="Main navigation">
      <div class="brand">
        <div>
          <h3 style="margin:0">SF0</h3>
          <div class="small-muted">Start From Zero</div>
        </div>
      </div>

      <div class="nav" id="mainNav">
        <div class="nav-item" data-target="home"><div class="icon">🏠</div><div class="label">Home</div></div>
        <div class="nav-item" data-target="videos"><div class="icon">🎥</div><div class="label">Videos</div></div>
        <div class="nav-item" data-target="posts"><div class="icon">📝</div><div class="label">Posts</div></div>
        <div class="nav-item" data-target="positives"><div class="icon">🌟</div><div class="label">Positive Thinking</div></div>
        <div class="nav-item" data-target="growth"><div class="icon">📈</div><div class="label">Growth</div></div>
        <div class="nav-item" data-target="complaints"><div class="icon">✉️</div><div class="label">Complaints</div></div>
        <div class="nav-item" data-target="admins"><div class="icon">🛠️</div><div class="label">Manage Admins</div></div>
        <div class="nav-item" data-target="details"><div class="icon">📊</div><div class="label">User Details</div></div>
        <div class="nav-item" data-target="about"><div class="icon">ℹ️</div><div class="label">About</div></div>
        <div class="nav-item" data-target="contact"><div class="icon">📞</div><div class="label">Contact</div></div>
        <div class="nav-item logout" id="logoutBtn"><div class="label">Logout</div></div>
      </div>
    </nav>

    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <main class="content">
      <section id="home" class="card" style="display:block">
        <div class="flex-between">
          <h3 style="margin:0">Current Weather</h3>
        </div>
        <div id="weatherContent" class="muted">Loading...</div>
        <div class="flex-between">
          <h3 style="margin:0">Welcome</h3>
          <div class="tag" id="roleTag">—</div>
        </div>
        <div class="welcome-graphic">
          <svg width="200" height="100" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
            <text x="100" y="60" font-size="50" text-anchor="middle" fill="none" stroke="var(--blue)" stroke-width="3" font-family="Inter, sans-serif" font-weight="700">
              SF0
              <animate attributeName="stroke-dasharray" from="0 300" to="300 0" dur="2s" repeatCount="indefinite"/>
              <animate attributeName="stroke-dashoffset" from="300" to="0" dur="2s" repeatCount="indefinite"/>
            </text>
            <path d="M20 80 Q100 40 180 80" stroke="var(--blue)" stroke-width="4" fill="none">
              <animate attributeName="d" values="M20 80 Q100 40 180 80; M20 80 Q100 60 180 80; M20 80 Q100 40 180 80" dur="2s" repeatCount="indefinite"/>
            </path>
          </svg>
        </div>
        <p class="welcome-message">Welcome to SF0</p>
        <p class="muted">Use the sidebar to navigate and explore our features.</p>
        <div style="margin-top: 32px; text-align:center">
          <button class="btn ai-glow" id="worldnewsBtn">Explore World News</button>
        </div>
      </section>

      <section id="videos" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0">Videos</h3>
          <div class="small-muted">Admins can upload & edit</div>
        </div>

        <div id="videoAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Upload video (admin)</h4>
          <input id="videoTitle" placeholder="Title" />
          <input id="videoUrl" placeholder="YouTube Link (e.g. https://www.youtube.com/watch?v=...)" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadVideo" class="btn">Upload</button>
            <button id="clearVideo" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="videoList" style="margin-top:12px"></div>
      </section>

      <section id="posts" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0">Posts</h3>
          <div class="small-muted">Admins can create posts</div>
        </div>

        <div id="postAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create post (admin)</h4>
          <input id="postTitle" placeholder="Title" />
          <textarea id="postText" placeholder="Post body" style="margin-top:8px"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="uploadPost" class="btn">Publish</button>
            <button id="clearPost" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="postList" style="margin-top:12px"></div>
      </section>

      <section id="positives" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0">Positive Thinking</h3>
          <div class="small-muted">Admins can add/edit/delete</div>
        </div>

        <div id="positiveAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create Positive (admin)</h4>
          <input id="positiveTitle" placeholder="Title" />
          <textarea id="positiveText" placeholder="Text" style="margin-top:8px"></textarea>
          <input id="positiveImageFile" type="file" accept="image/*" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadPositive" class="btn">Publish</button>
            <button id="clearPositive" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="positiveList" style="margin-top:12px"></div>
      </section>

      <section id="growth" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Growth Analytics</h3>
        <p class="muted">User growth over time is visible here.</p>
        <canvas id="growthChart" style="max-height:400px"></canvas>
      </section>

      <section id="complaints" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Complaint Center</h3>

        <div class="card" style="margin-bottom:16px">
          <h4 style="margin:0 0 8px 0">Submit a Private Complaint</h4>
          <textarea id="complaintText" placeholder="Write your private complaint here..."></textarea>
          <div class="row" style="margin-top:8px">
            <button id="sendComplaint" class="btn">Send complaint (private)</button>
            <div id="complaintMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
          </div>
          <div class="muted" style="margin-top:8px">Your message will not be visible to other users.</div>
        </div>

        <div id="userComplaintHistory" class="user-reply-history">
          <h4 style="margin:0 0 8px 0">Your Complaint History</h4>
          <div id="userComplaintsList"></div>
        </div>

        <div id="complaintAdmin" class="admin-panel card" style="display:none; margin-top:16px">
          <h4 style="margin:0 0 8px 0">All Complaints (Admin View)</h4>
          <div id="complaintsList"></div>
        </div>
      </section>

      <section id="admins" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Manage Admins</h3>
        <div id="adminManageControls" style="display:none">
          <input id="adminEmailInput" placeholder="User email (to promote/demote)" />
          <div class="row" style="margin-top:8px">
            <button id="promoteBtn" class="btn">Promote to Admin</button>
            <button id="demoteBtn" class="small-btn" style="background:#fee">Demote to User</button>
          </div>
        </div>
        <div id="adminsList" style="margin-top:12px"></div>
      </section>

      <section id="details" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">User Details (Admin View)</h3>
        <input id="userSearch" placeholder="Search by email or name" style="margin-bottom:8px;width:100%;">
        <table id="userTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>DOB</th>
              <th>Gender</th>
              <th>Contact Number</th>
              <th>Role</th>
              <th>Created At</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="about" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">About Us</h3>
        <div id="aboutAdmin" class="admin-panel card" style="margin-bottom:16px">
          <h4 style="margin:0 0 8px 0">Edit About Content (Admin)</h4>
          <textarea id="aboutTextarea" placeholder="Write the main 'About Us' content here..."></textarea>
          <div class="row" style="margin-top:8px">
            <button id="saveAboutBtn" class="btn">Save Content</button>
            <button id="clearAboutBtn" class="small-btn" style="background:#fee">Clear Content</button>
            <div id="aboutMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
          </div>
        </div>
        <div id="aboutContent" style="white-space: pre-wrap">
          <p class="muted">Loading content...</p>
        </div>
      </section>

      <section id="contact" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Contact & Social Profiles</h3>
        <div id="socialAdmin" class="admin-panel card" style="margin-bottom:16px">
          <h4 style="margin:0 0 8px 0">Set Social Media Links (Admin)</h4>
          <input id="socialFb" placeholder="Facebook URL (e.g. https://facebook.com/user)" />
          <input id="socialTw" placeholder="Twitter URL (e.g. https://twitter.com/user)" style="margin-top:8px" />
          <input id="socialLi" placeholder="LinkedIn URL (e.g. https://linkedin.com/in/user)" style="margin-top:8px" />
          <div class="row" style="margin-top:8px">
            <button id="setSocialsBtn" class="btn">Save Socials</button>
            <div id="socialMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
          </div>
        </div>
        <div class="social-links" id="socialLinksDisplay">
          <p class="muted">Follow us on social media:</p>
        </div>
        <div class="muted" style="margin-top:16px">For complaints, please use the Complaints section in the sidebar.</div>
      </section>

      <section id="sports" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0" class="ai-glow">Sports News</h3>
          <button class="small-btn back-wn">Back</button>
        </div>
        <div class="muted">Latest updates in sports.</div>

        <div id="sportsAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create Sports News (admin)</h4>
          <input id="sportsTitle" placeholder="Title" />
          <textarea id="sportsText" placeholder="Text" style="margin-top:8px"></textarea>
          <input id="sportsImageFile" type="file" accept="image/*" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadSports" class="btn">Publish</button>
            <button id="clearSports" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="sportsList" style="margin-top:12px"></div>
      </section>

      <section id="technology" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0" class="ai-glow">Technology News</h3>
          <button class="small-btn back-wn">Back</button>
        </div>
        <div class="muted">Latest updates in technology.</div>

        <div id="technologyAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create Technology News (admin)</h4>
          <input id="technologyTitle" placeholder="Title" />
          <textarea id="technologyText" placeholder="Text" style="margin-top:8px"></textarea>
          <input id="technologyImageFile" type="file" accept="image/*" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadTechnology" class="btn">Publish</button>
            <button id="clearTechnology" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="technologyList" style="margin-top:12px"></div>
      </section>

      <section id="business" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0" class="ai-glow">Business News</h3>
          <button class="small-btn back-wn">Back</button>
        </div>
        <div class="muted">Latest updates in business.</div>

        <div id="businessAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create Business News (admin)</h4>
          <input id="businessTitle" placeholder="Title" />
          <textarea id="businessText" placeholder="Text" style="margin-top:8px"></textarea>
          <input id="businessImageFile" type="file" accept="image/*" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadBusiness" class="btn">Publish</button>
            <button id="clearBusiness" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="businessList" style="margin-top:12px"></div>
      </section>

      <section id="others" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0" class="ai-glow">Other News</h3>
          <button class="small-btn back-wn">Back</button>
        </div>
        <div class="muted">Latest updates in other categories.</div>

        <div id="othersAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create Other News (admin)</h4>
          <input id="othersTitle" placeholder="Title" />
          <textarea id="othersText" placeholder="Text" style="margin-top:8px"></textarea>
          <input id="othersImageFile" type="file" accept="image/*" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadOthers" class="btn">Publish</button>
            <button id="clearOthers" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="othersList" style="margin-top:12px"></div>
      </section>

      <section id="worldnews" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0" class="ai-glow">World News</h3>
          <button class="small-btn back-wn">Back to Home</button>
        </div>
        <div class="muted">Choose a category</div>
        <div class="nav" style="flex-direction:row; justify-content:space-around; margin-top:16px;">
          <div class="nav-item" data-target="sports" style="flex:1; text-align:center"><div class="icon">⚽</div><div class="label">Sports</div></div>
          <div class="nav-item" data-target="technology" style="flex:1; text-align:center"><div class="icon">💻</div><div class="label">Technology</div></div>
          <div class="nav-item" data-target="business" style="flex:1; text-align:center"><div class="icon">💼</div><div class="label">Business</div></div>
          <div class="nav-item" data-target="others" style="flex:1; text-align:center"><div class="icon">🌐</div><div class="label">Others</div></div>
        </div>
      </section>

    </main>
  </div>

  <footer>SF0 • Official</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, set, push, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCkiB65lvUh04SbfXMfKNjx0GQwAKCcwTY",
  authDomain: "sf0-yt.firebaseapp.com",
  databaseURL: "https://sf0-yt-default-rtdb.firebaseio.com/",
  projectId: "sf0-yt",
  storageBucket: "sf0-yt.firebasestorage.app",
  messagingSenderId: "466855199003",
  appId: "1:466855199003:web:c42db7397a9cd3a37f13be"
};
const OWNER_EMAIL = "chanukamindiw2006@gmail.com";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

const authWrap = document.getElementById('authWrap');
const appWrap = document.getElementById('app');
const currentEmail = document.getElementById('currentEmail');
const roleTag = document.getElementById('roleTag');

const showLogin = id => {
  document.getElementById('loginView').style.display = id === 'login' ? 'block' : 'none';
  document.getElementById('signupView').style.display = id === 'signup' ? 'block' : 'none';
  document.getElementById('resetView').style.display = id === 'reset' ? 'block' : 'none';
  document.getElementById('detailsView').style.display = id === 'details' ? 'block' : 'none';
};

document.getElementById('showSignup').onclick = () => showLogin('signup');
document.getElementById('showLogin').onclick = () => showLogin('login');
document.getElementById('forgotBtn').onclick = () => showLogin('reset');
document.getElementById('backToLogin').onclick = () => showLogin('login');

document.getElementById('signupBtn').addEventListener('click', async () => {
  const email = document.getElementById('signupEmail').value.trim();
  const pass = document.getElementById('signupPass').value.trim();
  const firstName = document.getElementById('signupFirstName').value.trim();
  const lastName = document.getElementById('signupLastName').value.trim();
  const dob = document.getElementById('signupDob').value;
  const contact = document.getElementById('signupContact').value.trim();
  const gender = document.getElementById('signupGender').value;
  const errorEl = document.getElementById('signupError');
  errorEl.textContent = '';
  if (!email || pass.length < 6 || !firstName || !lastName || !dob || !contact || !gender) {
    errorEl.textContent = 'All fields are required';
    return;
  }
  try {
    const uc = await createUserWithEmailAndPassword(auth, email, pass);
    await sendEmailVerification(uc.user);
    const role = (email === OWNER_EMAIL) ? 'owner' : 'user';
    await set(ref(db, 'users/' + uc.user.uid), { email, role, firstName, lastName, dob, contact, gender, createdAt: Date.now() });
    await signOut(auth);
    alert('Account created. Please verify your email (check Spam). You must verify before login.');
    showLogin('login');
    document.getElementById('signupEmail').value = '';
    document.getElementById('signupPass').value = '';
    document.getElementById('signupFirstName').value = '';
    document.getElementById('signupLastName').value = '';
    document.getElementById('signupDob').value = '';
    document.getElementById('signupContact').value = '';
    document.getElementById('signupGender').value = '';
  } catch (e) {
    errorEl.textContent = e.message.includes('email-already-in-use') ? 'Email already in use' : e.message;
  }
});

document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  const errorEl = document.getElementById('loginError');
  errorEl.textContent = '';
  if (!email || !pass) {
    errorEl.textContent = 'Enter email & password';
    return;
  }
  try {
    const uc = await signInWithEmailAndPassword(auth, email, pass);
    if (!uc.user.emailVerified) {
      await signOut(auth);
      errorEl.textContent = 'Please verify your email before logging in.';
      return;
    }
    await update(ref(db, 'users/' + uc.user.uid), { last_login: Date.now() });
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
  } catch (e) {
    errorEl.textContent = e.message.includes('user-not-found') || e.message.includes('wrong-password')
      ? 'Invalid email or password'
      : e.message;
  }
});

document.getElementById('sendReset').addEventListener('click', async () => {
  const email = document.getElementById('resetEmail').value.trim();
  const errorEl = document.getElementById('resetError');
  const msgEl = document.getElementById('resetMsg');
  errorEl.textContent = '';
  msgEl.textContent = '';
  if (!email) {
    errorEl.textContent = 'Enter your email';
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    msgEl.textContent = 'Password reset email sent. Check your inbox (and Spam).';
    document.getElementById('resetEmail').value = '';
  } catch (e) {
    errorEl.textContent = e.message.includes('user-not-found') ? 'No account found with this email' : e.message;
  }
});

document.getElementById('saveDetailsBtn').addEventListener('click', async () => {
  const firstName = document.getElementById('detailsFirstName').value.trim();
  const lastName = document.getElementById('detailsLastName').value.trim();
  const dob = document.getElementById('detailsDob').value;
  const contact = document.getElementById('detailsContact').value.trim();
  const gender = document.getElementById('detailsGender').value;
  const errorEl = document.getElementById('detailsError');
  errorEl.textContent = '';
  if (!firstName || !lastName || !dob || !contact || !gender) {
    errorEl.textContent = 'All fields are required';
    return;
  }
  const u = auth.currentUser;
  await update(ref(db, 'users/' + u.uid), { firstName, lastName, dob, contact, gender });
  authWrap.style.display = 'none';
  appWrap.style.display = 'block';
  currentEmail.textContent = u.email;
  await refreshRoleUI();
  await renderAll();
  showSection('home');
  // Check for birthday
  const snap = await get(ref(db, 'users/' + u.uid));
  if (snap.exists()) {
    const profile = snap.val();
    if (profile.dob) {
      const [y, m, d] = profile.dob.split('-');
      const now = new Date();
      if (now.getMonth() + 1 == parseInt(m) && now.getDate() == parseInt(d)) {
        const today = now.toDateString();
        if (profile.birthdayNotifSent !== today) {
          await notifyUser(u.uid, `Happy Birthday, ${profile.firstName}! 🎉`);
          await update(ref(db, 'users/' + u.uid), { birthdayNotifSent: today });
        }
      }
    }
  }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await signOut(auth);
  } catch (e) {
    alert('Error signing out: ' + e.message);
  }
});

const savedTheme = localStorage.getItem('sf0_theme') || 'light';
document.documentElement.setAttribute('data-theme', savedTheme === 'dark' ? 'dark' : 'light');

const navItems = Array.from(document.querySelectorAll('.nav-item'));
function setActiveNav(target) {
  navItems.forEach(it => {
    if (it.dataset.target === target) it.classList.add('active');
    else it.classList.remove('active');
  });
}
function showSection(id) {
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  const el = document.getElementById(id);
  if (el) {
    el.style.display = 'block';
    el.classList.add('show');
  }
  setActiveNav(id);
  if (window.innerWidth <= 900) closeSidebar();
  if (id === 'home') renderWeather();
  if (id === 'sports') renderSports();
  if (id === 'technology') renderTechnology();
  if (id === 'business') renderBusiness();
  if (id === 'others') renderOthers();
}
navItems.forEach(it => {
  if (it.dataset.target) {
    it.addEventListener('click', () => showSection(it.dataset.target));
  }
});

const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
function openSidebar() {
  sidebar.classList.add('open');
  overlay.classList.add('open');
  overlay.style.display = 'block';
  overlay.onclick = closeSidebar;
}
function closeSidebar() {
  sidebar.classList.remove('open');
  overlay.classList.remove('open');
  overlay.style.display = 'none';
  overlay.onclick = null;
}
menuToggle.addEventListener('click', () => {
  if (sidebar.classList.contains('open')) closeSidebar();
  else openSidebar();
});
window.addEventListener('resize', () => {
  if (window.innerWidth > 900) closeSidebar();
});

document.getElementById('worldnewsBtn').addEventListener('click', () => {
  showSection('worldnews');
});
document.querySelectorAll('.back-wn').forEach(btn => {
  btn.addEventListener('click', () => {
    showSection('home');
  });
});

async function getRoleForCurrentUser() {
  const u = auth.currentUser;
  if (!u) return null;
  const snap = await get(ref(db, 'users/' + u.uid));
  if (!snap.exists()) return null;
  return snap.val().role;
}

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const uRef = ref(db, 'users/' + user.uid);
    const snap = await get(uRef);
    if (!snap.exists()) {
      const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
      await set(uRef, { email: user.email, role, createdAt: Date.now() });
      authWrap.style.display = 'block';
      appWrap.style.display = 'none';
      showLogin('details');
      document.getElementById('detailsEmail').textContent = 'Email: ' + user.email;
    } else {
      const profile = snap.val();
      if (!profile.firstName || !profile.lastName || !profile.dob || !profile.contact || !profile.gender) {
        authWrap.style.display = 'block';
        appWrap.style.display = 'none';
        showLogin('details');
        document.getElementById('detailsEmail').textContent = 'Email: ' + user.email;
      } else {
        authWrap.style.display = 'none';
        appWrap.style.display = 'block';
        currentEmail.textContent = user.email;
        await refreshRoleUI();
        await renderAll();
        showSection('home');
        // Check for birthday
        if (profile.dob) {
          const [y, m, d] = profile.dob.split('-');
          const now = new Date();
          if (now.getMonth() + 1 == parseInt(m) && now.getDate() == parseInt(d)) {
            const today = now.toDateString();
            if (profile.birthdayNotifSent !== today) {
              await notifyUser(user.uid, `Happy Birthday, ${profile.firstName}! 🎉`);
              await update(ref(db, 'users/' + user.uid), { birthdayNotifSent: today });
            }
          }
        }
      }
      if (user.email === OWNER_EMAIL && profile.role !== 'owner') {
        await update(uRef, { role: 'owner' });
      }
      await update(uRef, { last_login: Date.now() });
    }
  } else {
    authWrap.style.display = 'block';
    appWrap.style.display = 'none';
    currentEmail.textContent = '';
    showLogin('login');
  }
});

async function refreshRoleUI() {
  const role = await getRoleForCurrentUser();
  roleTag.textContent = role ? role.toUpperCase() : '—';
  document.querySelectorAll('.admin-panel').forEach(p => p.style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none');
  document.getElementById('admins').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('details').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('adminManageControls').style.display = (role === 'owner') ? 'block' : 'none';
  document.getElementById('socialAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('complaintAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('aboutAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('positiveAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('sportsAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('technologyAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('businessAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  document.getElementById('othersAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';

  // Hide nav items for Manage Admins and User Details for users
  const adminsNav = document.querySelector('.nav-item[data-target="admins"]');
  const detailsNav = document.querySelector('.nav-item[data-target="details"]');
  const display = (role === 'admin' || role === 'owner') ? 'flex' : 'none';
  if (adminsNav) adminsNav.style.display = display;
  if (detailsNav) detailsNav.style.display = display;
}

function esc(s) {
  if (!s) return '';
  return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
}
function escAttr(s) {
  if (!s) return '';
  return String(s).replace(/"/g, '&quot;');
}

document.getElementById('uploadVideo').addEventListener('click', async () => {
  const title = document.getElementById('videoTitle').value.trim();
  const urlInput = document.getElementById('videoUrl').value.trim();
  if (!title || !urlInput) {
    alert('Title and YouTube URL required');
    return;
  }
  if (!urlInput.includes('youtube.com/') && !urlInput.includes('youtu.be/')) {
    alert('Please provide a valid YouTube URL.');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    await push(ref(db, 'videos'), { title, url: urlInput, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New video added: ${title}`);
    document.getElementById('videoTitle').value = '';
    document.getElementById('videoUrl').value = '';
    await renderVideos();
  } else alert('Only admins/owner can upload videos');
});

document.getElementById('clearVideo').addEventListener('click', () => {
  document.getElementById('videoTitle').value = '';
  document.getElementById('videoUrl').value = '';
});

async function renderVideos() {
  const listEl = document.getElementById('videoList');
  listEl.innerHTML = '';
  const snap = await get(ref(db, 'videos'));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No videos yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();

  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'video fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div>
          <a href="${escAttr(v.url)}" target="_blank" class="video-title-link">
            <strong>${esc(v.title)}</strong>
          </a>
          <div class="small-muted">Uploaded: ${new Date(v.createdAt).toLocaleString()}</div>
        </div>
        <div>
          <span class="small-muted">👍</span> <span class="count" id="vlikes-${k}">0</span>
        </div>
      </div>
      <div class="controls">
        <button class="small-btn like-btn" id="vlikes-btn-${k}" data-collection="videos" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="video" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="vcomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditVideos(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete video?')) {
          await remove(ref(db, 'videos/' + k));
          renderVideos();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#vlikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments('videos', k, 'video'));
    watchLikes('videos', k, `vlikes-${k}`, `vlikes-btn-${k}`);
  });
}

function inlineEditVideos(key, data) {
  const wrapper = document.querySelector(`#videoList .video .like-btn[data-id="${key}"]`)?.closest('.video');
  if (!wrapper) {
    renderVideos();
    return;
  }
  const titleEl = wrapper.querySelector('.video-title-link strong');
  const url = wrapper.querySelector('.video-title-link').href;
  titleEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <input class="edit-url" value="${escAttr(url)}" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    titleEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nu = form.querySelector('.edit-url').value.trim();
    if (!nt || !nu) {
      alert('Title & URL required');
      return;
    }
    await update(ref(db, 'videos/' + key), { title: nt, url: nu });
    await renderVideos();
  };
}

document.getElementById('uploadPost').addEventListener('click', async () => {
  const title = document.getElementById('postTitle').value.trim();
  const text = document.getElementById('postText').value.trim();
  if (!title || !text) {
    alert('Title & body required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    await push(ref(db, 'posts'), { title, text, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New post: ${title}`);
    document.getElementById('postTitle').value = '';
    document.getElementById('postText').value = '';
    await renderPosts();
  } else alert('Only admins/owner can create posts');
});

document.getElementById('clearPost').addEventListener('click', () => {
  document.getElementById('postTitle').value = '';
  document.getElementById('postText').value = '';
});

async function renderPosts() {
  const listEl = document.getElementById('postList');
  listEl.innerHTML = '';
  const snap = await get(ref(db, 'posts'));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No posts yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'post fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Posted: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="plikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px">${esc(v.text)}</div>
      <div class="controls">
        <button class="small-btn like-btn" id="plikes-btn-${k}" data-collection="posts" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="post" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="pcomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditPosts(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete post?')) {
          await remove(ref(db, 'posts/' + k));
          renderPosts();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#plikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments('posts', k, 'post'));
    watchLikes('posts', k, `plikes-${k}`, `plikes-btn-${k}`);
  });
}

function inlineEditPosts(key, data) {
  const wrapper = document.querySelector(`#postList .post .like-btn[data-id="${key}"]`)?.closest('.post');
  if (!wrapper) {
    renderPosts();
    return;
  }
  const titleEl = wrapper.querySelector('strong');
  const bodyEl = wrapper.querySelector('div:nth-child(2)');
  titleEl.style.display = 'none';
  bodyEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    titleEl.style.display = 'block';
    bodyEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    if (!nt || !nc) {
      alert('Title & body required');
      return;
    }
    await update(ref(db, 'posts/' + key), { title: nt, text: nc });
    await renderPosts();
  };
}

document.getElementById('uploadPositive').addEventListener('click', async () => {
  const title = document.getElementById('positiveTitle').value.trim();
  const text = document.getElementById('positiveText').value.trim();
  const file = document.getElementById('positiveImageFile').files[0];
  if (!title || !text) {
    alert('Title & text required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    let image = '';
    if (file) {
      const sRef = storageRef(storage, 'positives/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      image = await getDownloadURL(sRef);
    }
    await push(ref(db, 'positives'), { title, text, image, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New positive thinking: ${title}`);
    document.getElementById('positiveTitle').value = '';
    document.getElementById('positiveText').value = '';
    document.getElementById('positiveImageFile').value = '';
    await renderPositives();
  } else alert('Only admins/owner can add positives');
});

document.getElementById('clearPositive').addEventListener('click', () => {
  document.getElementById('positiveTitle').value = '';
  document.getElementById('positiveText').value = '';
  document.getElementById('positiveImageFile').value = '';
});

async function renderPositives() {
  const listEl = document.getElementById('positiveList');
  listEl.innerHTML = '';
  const snap = await get(ref(db, 'positives'));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No positives yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'positive fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Added: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="positlikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p style="text-align: justify;">${esc(v.text)}</p></div>
      ${v.image ? `<img src="${escAttr(v.image)}" alt="${esc(v.title)}" style="max-width:100%;border-radius:8px;margin-top:8px;display:block;">` : ''}
      <div class="controls">
        <button class="small-btn like-btn" id="positlikes-btn-${k}" data-collection="positives" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="positive" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="positcomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditPositives(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete positive?')) {
          await remove(ref(db, 'positives/' + k));
          renderPositives();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#positlikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments('positives', k, 'positive'));
    watchLikes('positives', k, `positlikes-${k}`, `positlikes-btn-${k}`);
  });
}

function inlineEditPositives(key, data) {
  const wrapper = document.querySelector(`#positiveList .positive .like-btn[data-id="${key}"]`)?.closest('.positive');
  if (!wrapper) {
    renderPositives();
    return;
  }
  const body = wrapper.querySelector('div:nth-child(2)');
  const imageEl = wrapper.querySelector('img');
  if (body) body.style.display = 'none';
  if (imageEl) imageEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <input class="edit-image-file" type="file" accept="image/*" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    if (body) body.style.display = 'block';
    if (imageEl) imageEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    const file = form.querySelector('.edit-image-file').files[0];
    if (!nt || !nc) {
      alert('Title & text required');
      return;
    }
    let ni = data.image || '';
    if (file) {
      const sRef = storageRef(storage, 'positives/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      ni = await getDownloadURL(sRef);
    }
    await update(ref(db, 'positives/' + key), { title: nt, text: nc, image: ni });
    await renderPositives();
  };
}

async function renderGrowth() {
  const ctx = document.getElementById('growthChart')?.getContext('2d');
  if (!ctx) return;
  const snap = await get(ref(db, 'users'));
  let dates = [];
  let counts = [];
  snap.forEach(c => {
    const ts = new Date(c.val().createdAt).toLocaleDateString();
    const i = dates.indexOf(ts);
    if (i === -1) {
      dates.push(ts);
      counts.push(1);
    } else {
      counts[i]++;
    }
  });
  dates.sort((a, b) => new Date(a) - new Date(b));
  let cumulative = 0;
  const cumCounts = counts.map((c, i) => {
    cumulative += counts[i];
    return cumulative;
  });
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Users',
        data: cumCounts,
        borderColor: 'var(--blue)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

async function toggleLike(collection, id, btnEl) {
  const u = auth.currentUser;
  if (!u) {
    alert('Login to like');
    return;
  }
  const likeRef = ref(db, `likes/${collection}/${id}/${u.uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) {
    await remove(likeRef);
    btnEl.classList.remove('liked');
  } else {
    await set(likeRef, { likedAt: Date.now() });
    btnEl.classList.add('liked');
  }
}

function watchLikes(collection, id, counterId, btnId) {
  const u = auth.currentUser;
  const counterEl = document.getElementById(counterId);
  const btnEl = document.getElementById(btnId);
  const likesRef = ref(db, `likes/${collection}/${id}`);
  onValue(likesRef, (snap) => {
    const likes = snap.exists() ? snap.val() : {};
    const count = Object.keys(likes).length;
    if (counterEl) counterEl.textContent = count;
    if (btnEl && u) {
      if (likes[u.uid]) btnEl.classList.add('liked');
      else btnEl.classList.remove('liked');
    }
  }, { onlyOnce: false });
}

async function toggleComments(collectionPath, itemId, type) {
  let prefix;
  if (type === 'video') prefix = 'vcomments-';
  else if (type === 'post') prefix = 'pcomments-';
  else if (type === 'positive') prefix = 'positcomments-';
  else if (type === 'sports') prefix = 'sportscomments-';
  else if (type === 'technology') prefix = 'technologycomments-';
  else if (type === 'business') prefix = 'businesscomments-';
  else if (type === 'others') prefix = 'otherscomments-';
  const wrapperId = prefix + itemId;
  const box = document.getElementById(wrapperId);
  if (!box) return;
  if (box.style.display === 'block') {
    box.style.display = 'none';
    return;
  }
  box.style.display = 'block';
  const commentsList = box.querySelector('.comments-list');
  const postBtn = box.querySelector('.postComment');
  postBtn.addEventListener('click', async () => {
    const txt = box.querySelector('.new-comment').value.trim();
    if (!txt) {
      alert('Type a comment');
      return;
    }
    const u = auth.currentUser;
    if (!u) {
      alert('Login to comment');
      return;
    }
    const cobj = { uid: u.uid, text: txt, email: u.email, createdAt: Date.now() };
    await push(ref(db, `comments/${collectionPath}/${itemId}`), cobj);
    box.querySelector('.new-comment').value = '';
    await renderComments(collectionPath, itemId, commentsList);
  }, { once: true });
  await renderComments(collectionPath, itemId, commentsList);
}

async function renderComments(collectionPath, itemId, container) {
  container.innerHTML = '';
  const snap = await get(ref(db, `comments/${collectionPath}/${itemId}`));
  if (!snap.exists()) {
    container.innerHTML = '<div class="small-muted">No comments yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(c => {
    const cm = c.val();
    const k = c.key;
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div><strong>${esc(cm.email)}</strong> <span class="small-muted">${new Date(cm.createdAt).toLocaleString()}</span></div>
      </div>
      <div style="margin-top:6px">${esc(cm.text)}</div>
    `;
    const u = auth.currentUser;
    if (u && (u.uid === cm.uid || role === 'admin' || role === 'owner')) {
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete this comment?')) {
          await remove(ref(db, `comments/${collectionPath}/${itemId}/${k}`));
          renderComments(collectionPath, itemId, container);
        }
      };
      div.querySelector('div').appendChild(del);
    }
    container.appendChild(div);
  });
}

document.getElementById('sendComplaint').addEventListener('click', async () => {
  const txt = document.getElementById('complaintText').value.trim();
  document.getElementById('complaintMsg').textContent = '';
  if (!txt) {
    document.getElementById('complaintMsg').textContent = 'Enter a message';
    return;
  }
  const u = auth.currentUser;
  if (!u) {
    alert('Login to submit complaint');
    return;
  }
  await push(ref(db, 'complaints'), { uid: u.uid, email: u.email, text: txt, createdAt: Date.now(), seen: false });
  document.getElementById('complaintText').value = '';
  document.getElementById('complaintMsg').textContent = 'Complaint sent (private).';
  await renderUserComplaints();
});

async function renderComplaints() {
  const list = document.getElementById('complaintsList');
  if (!list) return;
  list.innerHTML = '';
  const snap = await get(ref(db, 'complaints'));
  if (!snap.exists()) {
    list.innerHTML = '<div class="muted">No complaints yet</div>';
    return;
  }
  snap.forEach(c => {
    const cm = c.val();
    const k = c.key;
    const row = document.createElement('div');
    row.className = 'complaint fade-in';
    row.style.display = 'flex';
    row.style.flexDirection = 'column';
    row.style.gap = '8px';
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div>
          <strong>${esc(cm.email)}</strong>
          <div class="small-muted">${new Date(cm.createdAt).toLocaleString()}</div>
        </div>
        <div>
          <span class="tag">${cm.seen ? 'Seen' : 'New'}</span>
        </div>
      </div>
      <div style="margin-top:0">
        <p><strong>Complaint:</strong> ${esc(cm.text)}</p>
      </div>
    `;
    const controls = document.createElement('div');
    controls.className = 'row';
    const mark = document.createElement('button');
    mark.className = 'small-btn';
    mark.textContent = cm.seen ? 'Mark unread' : 'Mark seen';
    mark.onclick = async () => {
      await update(ref(db, 'complaints/' + k), { seen: !cm.seen });
      renderComplaints();
    };
    const del = document.createElement('button');
    del.className = 'small-btn';
    del.style.background = '#fee';
    del.textContent = 'Delete';
    del.onclick = async () => {
      if (confirm('Delete complaint?')) {
        await remove(ref(db, 'complaints/' + k));
        renderComplaints();
      }
    };
    controls.appendChild(mark);
    controls.appendChild(del);
    row.appendChild(controls);
    const replyBox = document.createElement('div');
    replyBox.className = 'admin-reply-box';
    if (cm.replyText) {
      replyBox.innerHTML = `
        <p><strong>Admin Reply:</strong> ${esc(cm.replyText)}</p>
        <div class="small-muted">Replied by ${esc(cm.repliedByEmail)} on ${new Date(cm.repliedAt).toLocaleString()}</div>
      `;
    } else {
      replyBox.innerHTML = `
        <textarea placeholder="Write a private reply to ${esc(cm.email)}..." class="reply-textarea" style="width:100%;min-height:60px"></textarea>
        <button class="btn send-reply-btn" style="margin-top:8px">Send Reply</button>
      `;
      replyBox.querySelector('.send-reply-btn').onclick = async () => {
        const replyText = replyBox.querySelector('.reply-textarea').value.trim();
        if (!replyText) {
          alert('Reply text is required');
          return;
        }
        const u = auth.currentUser;
        await update(ref(db, 'complaints/' + k), {
          replyText,
          repliedAt: Date.now(),
          repliedBy: u.uid,
          repliedByEmail: u.email,
          seen: true
        });
        await notifyUser(u.uid, 'Admin replied to your complaint');
        renderComplaints();
        renderUserComplaints();
      };
    }
    row.appendChild(replyBox);
    list.appendChild(row);
  });
}

async function renderUserComplaints() {
  const list = document.getElementById('userComplaintsList');
  if (!list) return;
  list.innerHTML = '';
  const u = auth.currentUser;
  if (!u) {
    list.innerHTML = '<div class="muted">Please log in to see your complaint history.</div>';
    return;
  }
  const snap = await get(ref(db, 'complaints'));
  const userComplaints = [];
  snap.forEach(c => {
    const cm = c.val();
    if (cm.uid === u.uid) {
      userComplaints.push({ ...cm, key: c.key });
    }
  });
  if (userComplaints.length === 0) {
    list.innerHTML = '<div class="muted">You have no complaints on file.</div>';
    return;
  }
  userComplaints.sort((a, b) => b.createdAt - a.createdAt);
  userComplaints.forEach(cm => {
    const row = document.createElement('div');
    row.className = 'complaint fade-in';
    let replyHtml = '';
    if (cm.replyText) {
      replyHtml = `
        <div class="admin-reply-box" style="margin-top:10px">
          <strong style="color:var(--blue)">Admin Reply:</strong>
          <p style="margin:4px 0 0 0">${esc(cm.replyText)}</p>
          <div class="small-muted" style="margin-top:4px">Replied on ${new Date(cm.repliedAt).toLocaleString()}</div>
        </div>`;
    } else {
      replyHtml = '<div class="small-muted" style="margin-top:10px;font-weight:600">Status: Waiting for Admin Reply</div>';
    }
    row.innerHTML = `
      <div>
        <strong>Your Complaint:</strong>
        <span class="small-muted">${new Date(cm.createdAt).toLocaleString()}</span>
      </div>
      <p style="margin:4px 0 0 0">${esc(cm.text)}</p>
      ${replyHtml}
    `;
    list.appendChild(row);
  });
}

function watchAbout() {
  const displayEl = document.getElementById('aboutContent');
  const textareaEl = document.getElementById('aboutTextarea');
  onValue(ref(db, 'about/content'), (snap) => {
    const content = snap.val() || '';
    if (displayEl) {
      displayEl.textContent = content || 'No "About Us" content has been set yet.';
      if (content) displayEl.classList.remove('muted');
      else displayEl.classList.add('muted');
    }
    if (textareaEl) textareaEl.value = content;
  }, { onlyOnce: false });
}

document.getElementById('saveAboutBtn').addEventListener('click', async () => {
  const content = document.getElementById('aboutTextarea').value.trim();
  document.getElementById('aboutMsg').textContent = '';
  const role = await getRoleForCurrentUser();
  if (role !== 'admin' && role !== 'owner') {
    document.getElementById('aboutMsg').textContent = 'Only admins can edit this content.';
    return;
  }
  await set(ref(db, 'about/content'), content);
  document.getElementById('aboutMsg').textContent = 'About content saved/updated.';
});

document.getElementById('clearAboutBtn').addEventListener('click', async () => {
  const role = await getRoleForCurrentUser();
  if (role !== 'admin' && role !== 'owner') {
    document.getElementById('aboutMsg').textContent = 'Only admins can clear this content.';
    return;
  }
  if (confirm('Are you sure you want to completely clear/delete the About Us content?')) {
    await remove(ref(db, 'about/content'));
    document.getElementById('aboutMsg').textContent = 'About content cleared/deleted.';
    document.getElementById('aboutTextarea').value = '';
  }
});

async function renderAbout() {
  watchAbout();
}

document.getElementById('setSocialsBtn').addEventListener('click', async () => {
  const fb = document.getElementById('socialFb').value.trim();
  const tw = document.getElementById('socialTw').value.trim();
  const li = document.getElementById('socialLi').value.trim();
  document.getElementById('socialMsg').textContent = '';
  const role = await getRoleForCurrentUser();
  if (role !== 'admin' && role !== 'owner') {
    document.getElementById('socialMsg').textContent = 'Only admins can set social links.';
    return;
  }
  const updates = {};
  if (fb) updates.facebook = fb;
  if (tw) updates.twitter = tw;
  if (li) updates.linkedin = li;
  if (Object.keys(updates).length > 0) {
    await set(ref(db, 'socials'), updates);
    document.getElementById('socialMsg').textContent = 'Social links saved.';
  } else {
    document.getElementById('socialMsg').textContent = 'No links entered.';
  }
});

function watchSocials() {
  const displayEl = document.getElementById('socialLinksDisplay');
  const inputFb = document.getElementById('socialFb');
  const inputTw = document.getElementById('socialTw');
  const inputLi = document.getElementById('socialLi');
  onValue(ref(db, 'socials'), (snap) => {
    const socials = snap.val() || {};
    let html = '<p class="muted">Follow us on social media:</p>';
    let hasLinks = false;
    if (socials.facebook) {
      html += `<a href="${escAttr(socials.facebook)}" target="_blank" title="Facebook">📘</a>`;
      hasLinks = true;
    }
    if (socials.twitter) {
      html += `<a href="${escAttr(socials.twitter)}" target="_blank" title="Twitter">🐦</a>`;
      hasLinks = true;
    }
    if (socials.linkedin) {
      html += `<a href="${escAttr(socials.linkedin)}" target="_blank" title="LinkedIn">🔗</a>`;
      hasLinks = true;
    }
    if (!hasLinks) {
      html = '<p class="muted">No social media profiles have been set yet.</p>';
    }
    displayEl.innerHTML = html;
    if (inputFb) inputFb.value = socials.facebook || '';
    if (inputTw) inputTw.value = socials.twitter || '';
    if (inputLi) inputLi.value = socials.linkedin || '';
  }, { onlyOnce: false });
}

async function renderContact() {
  watchSocials();
}

document.getElementById('promoteBtn').addEventListener('click', async () => {
  const email = document.getElementById('adminEmailInput').value.trim();
  if (!email) {
    alert('Enter email');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role !== 'owner') {
    alert('Only owner can add admins');
    return;
  }
  const usersSnap = await get(ref(db, 'users'));
  let foundUid = null;
  usersSnap.forEach(c => {
    if (c.val().email === email) foundUid = c.key;
  });
  if (!foundUid) {
    alert('User not found (they must sign up first)');
    return;
  }
  await update(ref(db, 'users/' + foundUid), { role: 'admin' });
  alert('Promoted to admin');
  await renderAdmins();
});

document.getElementById('demoteBtn').addEventListener('click', async () => {
  const email = document.getElementById('adminEmailInput').value.trim();
  if (!email) {
    alert('Enter email');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role !== 'owner') {
    alert('Only owner can demote admins');
    return;
  }
  const usersSnap = await get(ref(db, 'users'));
  let foundUid = null;
  usersSnap.forEach(c => {
    if (c.val().email === email) foundUid = c.key;
  });
  if (!foundUid) {
    alert('User not found');
    return;
  }
  await update(ref(db, 'users/' + foundUid), { role: 'user' });
  alert('Demoted to user');
  await renderAdmins();
});

async function renderAdmins() {
  const cont = document.getElementById('adminsList');
  cont.innerHTML = '';
  const role = await getRoleForCurrentUser();
  if (role !== 'admin' && role !== 'owner') {
    cont.innerHTML = '<div class="muted">Only admins/owner can view admin list</div>';
    return;
  }
  const usersSnap = await get(ref(db, 'users'));
  usersSnap.forEach(c => {
    const u = c.val();
    const uid = c.key;
    if (u.role === 'admin' || u.role === 'owner') {
      const row = document.createElement('div');
      row.className = 'admin-row fade-in';
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'center';
      row.innerHTML = `<div>${esc(u.email)} <span class="small-muted">(${u.role})</span></div>`;
      const actions = document.createElement('div');
      if (u.role === 'admin' && role === 'owner') {
        const dem = document.createElement('button');
        dem.className = 'small-btn';
        dem.textContent = 'Make user';
        dem.onclick = async () => {
          if (confirm('Demote this admin?')) {
            await update(ref(db, 'users/' + uid), { role: 'user' });
            renderAdmins();
          }
        };
        actions.appendChild(dem);
      } else {
        const info = document.createElement('span');
        info.className = 'small-muted';
        info.textContent = u.role.charAt(0).toUpperCase() + u.role.slice(1);
        actions.appendChild(info);
      }
      row.appendChild(actions);
      cont.appendChild(row);
    }
  });
}

let lastUsersSnap = null;

function renderUserTable() {
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '';
  const searchTerm = document.getElementById('userSearch').value.trim().toLowerCase();
  if (!lastUsersSnap || !lastUsersSnap.exists()) {
    tbody.innerHTML = '<tr><td colspan="9" class="muted">No users found</td></tr>';
    return;
  }
  let hasUsers = false;
  lastUsersSnap.forEach(c => {
    const u = c.val();
    const uid = c.key;
    const fullName = `${u.firstName || ''} ${u.lastName || ''}`.toLowerCase();
    const emailLower = u.email.toLowerCase();
    if (searchTerm && !fullName.includes(searchTerm) && !emailLower.includes(searchTerm)) {
      return;
    }
    hasUsers = true;
    const row = document.createElement('tr');
    row.setAttribute('data-uid', uid);
    row.innerHTML = `
      <td>${esc(u.email)}</td>
      <td>${esc(u.firstName || '')}</td>
      <td>${esc(u.lastName || '')}</td>
      <td>${esc(u.dob || '')}</td>
      <td>${esc(u.gender || '')}</td>
      <td>${esc(u.contact || '')}</td>
      <td>${esc(u.role || '')}</td>
      <td>${u.createdAt ? new Date(u.createdAt).toLocaleString() : ''}</td>
      <td>${u.last_login ? new Date(u.last_login).toLocaleString() : ''}</td>
    `;
    tbody.appendChild(row);
  });
  if (!hasUsers) {
    tbody.innerHTML = '<tr><td colspan="9" class="muted">No users found matching search</td></tr>';
  }
}

async function renderDetails() {
  const role = await getRoleForCurrentUser();
  if (role !== 'admin' && role === 'owner') {
    return;
  }
  const usersRef = ref(db, 'users');
  onValue(usersRef, (snap) => {
    lastUsersSnap = snap;
    renderUserTable();
  });
  const searchInput = document.getElementById('userSearch');
  if (searchInput) {
    searchInput.addEventListener('input', renderUserTable);
  }
}

async function notifyAllUsers(message) {
  const snap = await get(ref(db, 'users'));
  snap.forEach(c => {
    const uid = c.key;
    push(ref(db, 'notifications/' + uid), { message, timestamp: Date.now(), read: false });
  });
}

async function notifyUser(uid, message) {
  push(ref(db, 'notifications/' + uid), { message, timestamp: Date.now(), read: false });
}

function renderNotifications() {
  const u = auth.currentUser;
  if (!u) return;
  const notifRef = ref(db, 'notifications/' + u.uid);
  onValue(notifRef, (snap) => {
    const list = document.getElementById('notifList');
    const countEl = document.getElementById('notifCount');
    list.innerHTML = '';
    if (!snap.exists()) {
      list.innerHTML = '<div class="muted">No notifications</div>';
      countEl.style.display = 'none';
      return;
    }
    let notifs = [];
    let unread = 0;
    snap.forEach(c => {
      const n = c.val();
      n.key = c.key;
      notifs.push(n);
      if (!n.read) unread++;
    });
    notifs.sort((a, b) => b.timestamp - a.timestamp);
    notifs.forEach(n => {
      const div = document.createElement('div');
      div.className = 'notification-item';
      div.style.fontWeight = n.read ? 'normal' : 'bold';
      div.innerHTML = `
        <div>${esc(n.message)}</div>
        <div class="small-muted">${new Date(n.timestamp).toLocaleString()}</div>
      `;
      list.appendChild(div);
    });
    if (unread > 0) {
      countEl.textContent = unread;
      countEl.style.display = 'inline-block';
    } else {
      countEl.style.display = 'none';
    }
  });
}

document.getElementById('notifToggle').addEventListener('click', async () => {
  const dropdown = document.getElementById('notifDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  if (dropdown.style.display === 'block') {
    // Mark all as read
    const snap = await get(ref(db, 'notifications/' + auth.currentUser.uid));
    if (snap.exists()) {
      const updates = {};
      snap.forEach(c => {
        if (!c.val().read) {
          updates[c.key + '/read'] = true;
        }
      });
      if (Object.keys(updates).length > 0) {
        await update(ref(db, 'notifications/' + auth.currentUser.uid), updates);
      }
    }
    document.getElementById('notifCount').style.display = 'none';
  }
});

document.getElementById('uploadSports').addEventListener('click', async () => {
  const title = document.getElementById('sportsTitle').value.trim();
  const text = document.getElementById('sportsText').value.trim();
  const file = document.getElementById('sportsImageFile').files[0];
  if (!title || !text) {
    alert('Title & text required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    let image = '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/sports/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      image = await getDownloadURL(sRef);
    }
    await push(ref(db, 'worldnews/sports'), { title, text, image, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New sports news added: ${title}`);
    document.getElementById('sportsTitle').value = '';
    document.getElementById('sportsText').value = '';
    document.getElementById('sportsImageFile').value = '';
    await renderSports();
  } else alert('Only admins/owner can add news');
});

document.getElementById('clearSports').addEventListener('click', () => {
  document.getElementById('sportsTitle').value = '';
  document.getElementById('sportsText').value = '';
  document.getElementById('sportsImageFile').value = '';
});

async function renderSports() {
  const listEl = document.getElementById('sportsList');
  listEl.innerHTML = '';
  const path = 'worldnews/sports';
  const snap = await get(ref(db, path));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No news yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'positive fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Added: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="sportslikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p style="text-align: justify;">${esc(v.text)}</p></div>
      ${v.image ? `<img src="${escAttr(v.image)}" alt="${esc(v.title)}" style="max-width:100%;border-radius:8px;margin-top:8px;display:block;">` : ''}
      <div class="controls">
        <button class="small-btn like-btn" id="sportslikes-btn-${k}" data-collection="worldnews/sports" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="sports" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="sportscomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditSports(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete news?')) {
          await remove(ref(db, path + '/' + k));
          renderSports();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#sportslikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments(path, k, 'sports'));
    watchLikes('worldnews/sports', k, `sportslikes-${k}`, `sportslikes-btn-${k}`);
  });
}

function inlineEditSports(key, data) {
  const wrapper = document.querySelector(`#sportsList .positive .like-btn[data-id="${key}"]`)?.closest('.positive');
  if (!wrapper) {
    renderSports();
    return;
  }
  const body = wrapper.querySelector('div:nth-child(2)');
  const imageEl = wrapper.querySelector('img');
  if (body) body.style.display = 'none';
  if (imageEl) imageEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <input class="edit-image-file" type="file" accept="image/*" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    if (body) body.style.display = 'block';
    if (imageEl) imageEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    const file = form.querySelector('.edit-image-file').files[0];
    if (!nt || !nc) {
      alert('Title & text required');
      return;
    }
    let ni = data.image || '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/sports/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      ni = await getDownloadURL(sRef);
    }
    await update(ref(db, 'worldnews/sports/' + key), { title: nt, text: nc, image: ni });
    await renderSports();
  };
}

document.getElementById('uploadTechnology').addEventListener('click', async () => {
  const title = document.getElementById('technologyTitle').value.trim();
  const text = document.getElementById('technologyText').value.trim();
  const file = document.getElementById('technologyImageFile').files[0];
  if (!title || !text) {
    alert('Title & text required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    let image = '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/technology/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      image = await getDownloadURL(sRef);
    }
    await push(ref(db, 'worldnews/technology'), { title, text, image, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New technology news added: ${title}`);
    document.getElementById('technologyTitle').value = '';
    document.getElementById('technologyText').value = '';
    document.getElementById('technologyImageFile').value = '';
    await renderTechnology();
  } else alert('Only admins/owner can add news');
});

document.getElementById('clearTechnology').addEventListener('click', () => {
  document.getElementById('technologyTitle').value = '';
  document.getElementById('technologyText').value = '';
  document.getElementById('technologyImageFile').value = '';
});

async function renderTechnology() {
  const listEl = document.getElementById('technologyList');
  listEl.innerHTML = '';
  const path = 'worldnews/technology';
  const snap = await get(ref(db, path));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No news yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'positive fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Added: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="technologylikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p style="text-align: justify;">${esc(v.text)}</p></div>
      ${v.image ? `<img src="${escAttr(v.image)}" alt="${esc(v.title)}" style="max-width:100%;border-radius:8px;margin-top:8px;display:block;">` : ''}
      <div class="controls">
        <button class="small-btn like-btn" id="technologylikes-btn-${k}" data-collection="worldnews/technology" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="technology" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="technologycomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditTechnology(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete news?')) {
          await remove(ref(db, path + '/' + k));
          renderTechnology();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#technologylikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments(path, k, 'technology'));
    watchLikes('worldnews/technology', k, `technologylikes-${k}`, `technologylikes-btn-${k}`);
  });
}

function inlineEditTechnology(key, data) {
  const wrapper = document.querySelector(`#technologyList .positive .like-btn[data-id="${key}"]`)?.closest('.positive');
  if (!wrapper) {
    renderTechnology();
    return;
  }
  const body = wrapper.querySelector('div:nth-child(2)');
  const imageEl = wrapper.querySelector('img');
  if (body) body.style.display = 'none';
  if (imageEl) imageEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <input class="edit-image-file" type="file" accept="image/*" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    if (body) body.style.display = 'block';
    if (imageEl) imageEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    const file = form.querySelector('.edit-image-file').files[0];
    if (!nt || !nc) {
      alert('Title & text required');
      return;
    }
    let ni = data.image || '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/technology/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      ni = await getDownloadURL(sRef);
    }
    await update(ref(db, 'worldnews/technology/' + key), { title: nt, text: nc, image: ni });
    await renderTechnology();
  };
}

document.getElementById('uploadBusiness').addEventListener('click', async () => {
  const title = document.getElementById('businessTitle').value.trim();
  const text = document.getElementById('businessText').value.trim();
  const file = document.getElementById('businessImageFile').files[0];
  if (!title || !text) {
    alert('Title & text required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    let image = '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/business/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      image = await getDownloadURL(sRef);
    }
    await push(ref(db, 'worldnews/business'), { title, text, image, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New business news added: ${title}`);
    document.getElementById('businessTitle').value = '';
    document.getElementById('businessText').value = '';
    document.getElementById('businessImageFile').value = '';
    await renderBusiness();
  } else alert('Only admins/owner can add news');
});

document.getElementById('clearBusiness').addEventListener('click', () => {
  document.getElementById('businessTitle').value = '';
  document.getElementById('businessText').value = '';
  document.getElementById('businessImageFile').value = '';
});

async function renderBusiness() {
  const listEl = document.getElementById('businessList');
  listEl.innerHTML = '';
  const path = 'worldnews/business';
  const snap = await get(ref(db, path));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No news yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'positive fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Added: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="businesslikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p style="text-align: justify;">${esc(v.text)}</p></div>
      ${v.image ? `<img src="${escAttr(v.image)}" alt="${esc(v.title)}" style="max-width:100%;border-radius:8px;margin-top:8px;display:block;">` : ''}
      <div class="controls">
        <button class="small-btn like-btn" id="businesslikes-btn-${k}" data-collection="worldnews/business" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="business" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="businesscomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditBusiness(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete news?')) {
          await remove(ref(db, path + '/' + k));
          renderBusiness();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#businesslikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments(path, k, 'business'));
    watchLikes('worldnews/business', k, `businesslikes-${k}`, `businesslikes-btn-${k}`);
  });
}

function inlineEditBusiness(key, data) {
  const wrapper = document.querySelector(`#businessList .positive .like-btn[data-id="${key}"]`)?.closest('.positive');
  if (!wrapper) {
    renderBusiness();
    return;
  }
  const body = wrapper.querySelector('div:nth-child(2)');
  const imageEl = wrapper.querySelector('img');
  if (body) body.style.display = 'none';
  if (imageEl) imageEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <input class="edit-image-file" type="file" accept="image/*" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    if (body) body.style.display = 'block';
    if (imageEl) imageEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    const file = form.querySelector('.edit-image-file').files[0];
    if (!nt || !nc) {
      alert('Title & text required');
      return;
    }
    let ni = data.image || '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/business/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      ni = await getDownloadURL(sRef);
    }
    await update(ref(db, 'worldnews/business/' + key), { title: nt, text: nc, image: ni });
    await renderBusiness();
  };
}

document.getElementById('uploadOthers').addEventListener('click', async () => {
  const title = document.getElementById('othersTitle').value.trim();
  const text = document.getElementById('othersText').value.trim();
  const file = document.getElementById('othersImageFile').files[0];
  if (!title || !text) {
    alert('Title & text required');
    return;
  }
  const role = await getRoleForCurrentUser();
  if (role === 'admin' || role === 'owner') {
    let image = '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/others/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      image = await getDownloadURL(sRef);
    }
    await push(ref(db, 'worldnews/others'), { title, text, image, uploader: auth.currentUser.uid, createdAt: Date.now() });
    await notifyAllUsers(`New others news added: ${title}`);
    document.getElementById('othersTitle').value = '';
    document.getElementById('othersText').value = '';
    document.getElementById('othersImageFile').value = '';
    await renderOthers();
  } else alert('Only admins/owner can add news');
});

document.getElementById('clearOthers').addEventListener('click', () => {
  document.getElementById('othersTitle').value = '';
  document.getElementById('othersText').value = '';
  document.getElementById('othersImageFile').value = '';
});

async function renderOthers() {
  const listEl = document.getElementById('othersList');
  listEl.innerHTML = '';
  const path = 'worldnews/others';
  const snap = await get(ref(db, path));
  if (!snap.exists()) {
    listEl.innerHTML = '<div class="muted">No news yet</div>';
    return;
  }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const wrapper = document.createElement('div');
    wrapper.className = 'positive fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(v.title)}</strong><div class="small-muted">Added: ${new Date(v.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">👍</span> <span class="count" id="otherslikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p style="text-align: justify;">${esc(v.text)}</p></div>
      ${v.image ? `<img src="${escAttr(v.image)}" alt="${esc(v.title)}" style="max-width:100%;border-radius:8px;margin-top:8px;display:block;">` : ''}
      <div class="controls">
        <button class="small-btn like-btn" id="otherslikes-btn-${k}" data-collection="worldnews/others" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="others" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="otherscomments-${k}" style="display:none">
        <div class="comment-form">
          <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn postComment">Post comment</button>
            <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
          </div>
        </div>
        <div class="comments-list"></div>
      </div>
    `;
    if (role === 'admin' || role === 'owner') {
      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.onclick = () => inlineEditOthers(k, v);
      const del = document.createElement('button');
      del.className = 'small-btn';
      del.style.background = '#fee';
      del.textContent = 'Delete';
      del.onclick = async () => {
        if (confirm('Delete news?')) {
          await remove(ref(db, path + '/' + k));
          renderOthers();
        }
      };
      wrapper.querySelector('.controls').appendChild(edit);
      wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);
    wrapper.querySelector(`#otherslikes-btn-${k}`).addEventListener('click', (e) => toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', () => toggleComments(path, k, 'others'));
    watchLikes('worldnews/others', k, `otherslikes-${k}`, `otherslikes-btn-${k}`);
  });
}

function inlineEditOthers(key, data) {
  const wrapper = document.querySelector(`#othersList .positive .like-btn[data-id="${key}"]`)?.closest('.positive');
  if (!wrapper) {
    renderOthers();
    return;
  }
  const body = wrapper.querySelector('div:nth-child(2)');
  const imageEl = wrapper.querySelector('img');
  if (body) body.style.display = 'none';
  if (imageEl) imageEl.style.display = 'none';
  const form = document.createElement('div');
  form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.text)}</textarea>
    <input class="edit-image-file" type="file" accept="image/*" />
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  wrapper.appendChild(form);
  form.querySelector('.cancel').onclick = () => {
    form.remove();
    if (body) body.style.display = 'block';
    if (imageEl) imageEl.style.display = 'block';
  };
  form.querySelector('.save').onclick = async () => {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    const file = form.querySelector('.edit-image-file').files[0];
    if (!nt || !nc) {
      alert('Title & text required');
      return;
    }
    let ni = data.image || '';
    if (file) {
      const sRef = storageRef(storage, 'worldnews/others/' + Date.now() + '_' + file.name);
      await uploadBytes(sRef, file);
      ni = await getDownloadURL(sRef);
    }
    await update(ref(db, 'worldnews/others/' + key), { title: nt, text: nc, image: ni });
    await renderOthers();
  };
}

async function renderWeather() {
  const content = document.getElementById('weatherContent');
  content.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://wttr.in/Colombo?format=j1');
    const data = await res.json();
    const current = data.current_condition[0];
    const temp = current.temp_C;
    const desc = current.weatherDesc[0].value;
    let icon = '';
    if (desc.toLowerCase().includes('sun')) icon = '☀️';
    else if (desc.toLowerCase().includes('cloud')) icon = '☁️';
    else if (desc.toLowerCase().includes('rain')) icon = '🌧️';
    else if (desc.toLowerCase().includes('snow')) icon = '❄️';
    else icon = '🌤️';
    content.innerHTML = `
      <p>Temperature: ${temp}°C</p>
      <p>Condition: ${desc}</p>
      <div style="font-size:50px">${icon}</div>
    `;
  } catch (e) {
    content.innerHTML = 'Error loading weather';
  }
}

async function renderAll() {
  await renderVideos();
  await renderPosts();
  await renderPositives();
  await renderGrowth();
  await renderAdmins();
  await renderComplaints();
  await renderUserComplaints();
  await renderContact();
  await renderAbout();
  await renderDetails();
  renderNotifications();
}

document.addEventListener('visibilitychange', () => {});
document.getElementById('app').style.display = 'none';
</script>
</body>
</html>
